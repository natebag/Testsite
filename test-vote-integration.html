<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vote Integration Test | MLG.clan</title>
  
  <!-- External Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  
  <!-- API Client and WebSocket Manager -->
  <script src="src/js/mlg-api-client-consolidated.js"></script>
  <script src="src/js/mlg-websocket-manager.js"></script>
  
  <!-- Voting Integration System -->
  <script type="module">
    import { getVotingIntegration, initializeVotingIntegration } from './src/js/mlg-voting-integration.js';
    import { getWalletManager } from './src/wallet/phantom-wallet.js';
    
    // Make voting system available globally for this page
    window.getVotingIntegration = getVotingIntegration;
    window.getWalletManager = getWalletManager;
    
    // Initialize voting when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('ğŸ§ª Initializing voting system for test page...');
        
        // Initialize wallet manager if not already available
        if (!window.phantomWalletManager) {
          window.phantomWalletManager = getWalletManager();
        }
        
        // Initialize voting integration
        window.MLGVotingIntegration = await initializeVotingIntegration();
        console.log('âœ… Voting system ready for testing');
        
        // Run automated tests
        setTimeout(() => {
          window.runVotingTests();
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Failed to initialize voting system on test page:', error);
      }
    });
  </script>
  
  <style>
    body {
      background: linear-gradient(135deg, #0a0a0f, #1a1a2e);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    
    .test-section {
      background: rgba(26, 26, 46, 0.8);
      border: 1px solid rgba(0, 255, 136, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .test-section:hover {
      border-color: rgba(0, 255, 136, 0.3);
      transform: translateY(-2px);
    }
    
    .test-result {
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }
    
    .test-pass { background-color: rgba(34, 197, 94, 0.1); color: #22c55e; }
    .test-fail { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .test-info { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Header -->
  <div class="bg-black bg-opacity-60 backdrop-blur-md border-b border-green-500 border-opacity-20">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <h1 class="text-2xl font-bold text-green-400">ğŸ§ª MLG Voting Integration Test Suite</h1>
      <p class="text-gray-400">Testing vote button functionality across all platform pages</p>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-8">
    
    <!-- Test Status Overview -->
    <div class="test-section rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold text-green-400 mb-4">ğŸ“Š Test Status Overview</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-green-400" id="tests-passed">0</div>
          <div class="text-sm text-gray-400">Tests Passed</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-red-400" id="tests-failed">0</div>
          <div class="text-sm text-gray-400">Tests Failed</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-400" id="tests-total">0</div>
          <div class="text-sm text-gray-400">Total Tests</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-bold" id="test-status">ğŸ”„</div>
          <div class="text-sm text-gray-400">Status</div>
        </div>
      </div>
    </div>
    
    <!-- Vote Button Tests -->
    <div class="test-section rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold text-green-400 mb-4">ğŸ—³ï¸ Vote Button Functionality</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        
        <!-- Test Vote Button 1 -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="font-bold text-white mb-2">Epic Gaming Clip #1</h3>
          <div class="flex items-center justify-between">
            <span class="text-green-400 vote-count" data-content-id="test-1">542</span>
            <button class="bg-green-500 hover:bg-green-400 text-black px-4 py-2 rounded font-bold transition-colors vote-btn" data-content-id="test-1" data-cost="25">
              Vote (25 MLG)
            </button>
          </div>
        </div>
        
        <!-- Test Vote Button 2 -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="font-bold text-white mb-2">Tournament Highlight #2</h3>
          <div class="flex items-center justify-between">
            <span class="text-green-400 vote-count" data-content-id="test-2">378</span>
            <button class="bg-green-500 hover:bg-green-400 text-black px-4 py-2 rounded font-bold transition-colors vote-btn" data-content-id="test-2" data-cost="25">
              Vote (25 MLG)
            </button>
          </div>
        </div>
        
        <!-- Test Free Vote Button -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="font-bold text-white mb-2">Free Vote Content #3</h3>
          <div class="flex items-center justify-between">
            <span class="text-green-400 vote-count" data-content-id="test-3">123</span>
            <button class="bg-blue-500 hover:bg-blue-400 text-white px-4 py-2 rounded font-bold transition-colors vote-btn" data-content-id="test-3" data-cost="0">
              Free Vote
            </button>
          </div>
        </div>
      </div>
      
      <button onclick="testVoteButtons()" class="bg-green-500 hover:bg-green-400 text-black px-6 py-2 rounded-lg font-bold transition-colors">
        ğŸ§ª Run Vote Button Tests
      </button>
    </div>
    
    <!-- Integration Tests -->
    <div class="test-section rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold text-green-400 mb-4">âš™ï¸ Integration Tests</h2>
      <div class="space-y-3">
        <button onclick="testApiIntegration()" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors text-left">
          ğŸ”Œ Test API Integration
        </button>
        <button onclick="testWebSocketConnection()" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded transition-colors text-left">
          ğŸ“¡ Test WebSocket Connection
        </button>
        <button onclick="testWalletConnection()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded transition-colors text-left">
          ğŸ‘› Test Wallet Connection
        </button>
        <button onclick="testVotingSystem()" class="w-full bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded transition-colors text-left">
          ğŸ—³ï¸ Test Voting System
        </button>
      </div>
    </div>
    
    <!-- Test Results -->
    <div class="test-section rounded-xl p-6">
      <h2 class="text-xl font-bold text-green-400 mb-4">ğŸ“ Test Results</h2>
      <div id="test-results" class="space-y-2 max-h-96 overflow-y-auto">
        <div class="test-result test-info">ğŸš€ Test suite initialized. Click buttons above to run tests.</div>
      </div>
      <button onclick="clearTestResults()" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded transition-colors">
        ğŸ—‘ï¸ Clear Results
      </button>
    </div>
  </div>

  <script>
    let testsPassed = 0;
    let testsFailed = 0;
    let testsTotal = 0;

    function updateTestStats() {
      document.getElementById('tests-passed').textContent = testsPassed;
      document.getElementById('tests-failed').textContent = testsFailed;
      document.getElementById('tests-total').textContent = testsTotal;
      
      const status = testsFailed === 0 ? 'âœ…' : 'âŒ';
      document.getElementById('test-status').textContent = status;
    }

    function logTestResult(message, type = 'info') {
      const resultsContainer = document.getElementById('test-results');
      const resultDiv = document.createElement('div');
      resultDiv.className = `test-result test-${type}`;
      resultDiv.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
      resultsContainer.appendChild(resultDiv);
      resultsContainer.scrollTop = resultsContainer.scrollHeight;
      
      testsTotal++;
      if (type === 'pass') testsPassed++;
      if (type === 'fail') testsFailed++;
      updateTestStats();
    }

    async function testVoteButtons() {
      logTestResult('ğŸ§ª Starting vote button tests...', 'info');
      
      const voteButtons = document.querySelectorAll('.vote-btn');
      logTestResult(`Found ${voteButtons.length} vote buttons`, 'info');
      
      for (const button of voteButtons) {
        const contentId = button.getAttribute('data-content-id');
        const cost = button.getAttribute('data-cost');
        
        try {
          logTestResult(`Testing vote button for content ${contentId} (${cost} MLG)`, 'info');
          
          // Test if clicking works without errors
          button.click();
          
          logTestResult(`âœ… Vote button ${contentId} clicked successfully`, 'pass');
        } catch (error) {
          logTestResult(`âŒ Vote button ${contentId} failed: ${error.message}`, 'fail');
        }
      }
      
      logTestResult('ğŸ Vote button tests completed', 'info');
    }

    async function testApiIntegration() {
      logTestResult('ğŸ”Œ Testing API Integration...', 'info');
      
      try {
        if (window.mlgApi) {
          logTestResult('âœ… MLG API Client found', 'pass');
          
          const healthCheck = await window.mlgApi.healthCheck();
          if (healthCheck) {
            logTestResult('âœ… API health check passed', 'pass');
          } else {
            logTestResult('âš ï¸ API health check failed (expected in demo)', 'info');
          }
          
          const status = await window.mlgApi.getStatus();
          logTestResult(`âœ… API status retrieved: ${status.platform}`, 'pass');
          
          const voting = await window.mlgApi.getVoting();
          logTestResult(`âœ… Voting data retrieved: ${voting.success}`, 'pass');
          
        } else {
          logTestResult('âŒ MLG API Client not found', 'fail');
        }
      } catch (error) {
        logTestResult(`âŒ API Integration test failed: ${error.message}`, 'fail');
      }
    }

    async function testWebSocketConnection() {
      logTestResult('ğŸ“¡ Testing WebSocket Connection...', 'info');
      
      try {
        if (window.MLGWebSocketManager) {
          logTestResult('âœ… WebSocket Manager found', 'pass');
          
          const status = window.MLGWebSocketManager.getConnectionStatus();
          logTestResult(`WebSocket status: Connected=${status.isConnected}, Fallback=${status.fallbackMode}`, 'info');
          
          if (status.isConnected) {
            logTestResult('âœ… WebSocket connected', 'pass');
          } else {
            logTestResult('âš ï¸ WebSocket using fallback mode', 'info');
          }
          
          const subscriptions = window.MLGWebSocketManager.getSubscriptions();
          logTestResult(`Active subscriptions: ${Object.keys(subscriptions).length}`, 'info');
          
        } else {
          logTestResult('âŒ WebSocket Manager not found', 'fail');
        }
      } catch (error) {
        logTestResult(`âŒ WebSocket test failed: ${error.message}`, 'fail');
      }
    }

    async function testWalletConnection() {
      logTestResult('ğŸ‘› Testing Wallet Connection...', 'info');
      
      try {
        if (window.phantomWalletManager) {
          logTestResult('âœ… Phantom Wallet Manager found', 'pass');
          
          if (window.phantom && window.phantom.solana) {
            logTestResult('âœ… Phantom wallet extension detected', 'pass');
          } else {
            logTestResult('âš ï¸ Phantom wallet extension not found', 'info');
          }
          
        } else {
          logTestResult('âŒ Phantom Wallet Manager not found', 'fail');
        }
      } catch (error) {
        logTestResult(`âŒ Wallet connection test failed: ${error.message}`, 'fail');
      }
    }

    async function testVotingSystem() {
      logTestResult('ğŸ—³ï¸ Testing Voting System...', 'info');
      
      try {
        if (window.MLGVotingIntegration) {
          logTestResult('âœ… MLG Voting Integration found', 'pass');
          
          const stats = await window.MLGVotingIntegration.getVotingStats();
          if (stats) {
            logTestResult(`âœ… Voting stats retrieved: ${JSON.stringify(stats)}`, 'pass');
          } else {
            logTestResult('âš ï¸ Voting stats returned null (wallet not connected)', 'info');
          }
          
        } else {
          logTestResult('âŒ MLG Voting Integration not found', 'fail');
        }
      } catch (error) {
        logTestResult(`âŒ Voting system test failed: ${error.message}`, 'fail');
      }
    }

    function clearTestResults() {
      document.getElementById('test-results').innerHTML = '<div class="test-result test-info">ğŸ—‘ï¸ Test results cleared.</div>';
      testsPassed = 0;
      testsFailed = 0;
      testsTotal = 0;
      updateTestStats();
    }

    // Global function to run all tests
    window.runVotingTests = async function() {
      logTestResult('ğŸš€ Running automated voting integration tests...', 'info');
      
      await testApiIntegration();
      await testWebSocketConnection();
      await testWalletConnection();
      await testVotingSystem();
      
      logTestResult('ğŸ Automated tests completed', 'info');
    };

    // Initialize icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>
</html>